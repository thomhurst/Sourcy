<Project>
  <!--
    Sourcy Root Detection
    =====================
    This props file finds the repository root at MSBuild evaluation time.

    Priority order:
    1. .sourcyroot (explicit marker file - highest priority)
    2. .git (as directory or file - handles normal repos, worktrees, and submodules)
    3. global.json (.NET SDK convention)
    4. Directory.Build.props (MSBuild convention - checked last as nested projects may have their own)

    Users can override by setting SourcyRootPath explicitly in their project file.
  -->

  <PropertyGroup>
    <!-- Only compute if not already set by user -->
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), '.sourcyroot'))</SourcyRootPath>
  </PropertyGroup>

  <!--
    .git detection using System.IO to find both directories and files.
    GetDirectoryNameOfFileAbove only finds files, but .git is usually a directory.
    Walk up to 10 levels to find .git (as directory OR file for worktrees/submodules).
    Uses Path.Combine for cross-platform path construction.
  -->
  <PropertyGroup Condition="'$(SourcyRootPath)' == ''">
    <_SourcyL0>$(MSBuildProjectDirectory)</_SourcyL0>
    <_SourcyL1>$([System.IO.Path]::GetDirectoryName('$(_SourcyL0)'))</_SourcyL1>
    <_SourcyL2>$([System.IO.Path]::GetDirectoryName('$(_SourcyL1)'))</_SourcyL2>
    <_SourcyL3>$([System.IO.Path]::GetDirectoryName('$(_SourcyL2)'))</_SourcyL3>
    <_SourcyL4>$([System.IO.Path]::GetDirectoryName('$(_SourcyL3)'))</_SourcyL4>
    <_SourcyL5>$([System.IO.Path]::GetDirectoryName('$(_SourcyL4)'))</_SourcyL5>
    <_SourcyL6>$([System.IO.Path]::GetDirectoryName('$(_SourcyL5)'))</_SourcyL6>
    <_SourcyL7>$([System.IO.Path]::GetDirectoryName('$(_SourcyL6)'))</_SourcyL7>
    <_SourcyL8>$([System.IO.Path]::GetDirectoryName('$(_SourcyL7)'))</_SourcyL8>
    <_SourcyL9>$([System.IO.Path]::GetDirectoryName('$(_SourcyL8)'))</_SourcyL9>

    <!-- Build .git paths using Path.Combine for cross-platform compatibility -->
    <_SourcyGit0>$([System.IO.Path]::Combine('$(_SourcyL0)', '.git'))</_SourcyGit0>
    <_SourcyGit1>$([System.IO.Path]::Combine('$(_SourcyL1)', '.git'))</_SourcyGit1>
    <_SourcyGit2>$([System.IO.Path]::Combine('$(_SourcyL2)', '.git'))</_SourcyGit2>
    <_SourcyGit3>$([System.IO.Path]::Combine('$(_SourcyL3)', '.git'))</_SourcyGit3>
    <_SourcyGit4>$([System.IO.Path]::Combine('$(_SourcyL4)', '.git'))</_SourcyGit4>
    <_SourcyGit5>$([System.IO.Path]::Combine('$(_SourcyL5)', '.git'))</_SourcyGit5>
    <_SourcyGit6>$([System.IO.Path]::Combine('$(_SourcyL6)', '.git'))</_SourcyGit6>
    <_SourcyGit7>$([System.IO.Path]::Combine('$(_SourcyL7)', '.git'))</_SourcyGit7>
    <_SourcyGit8>$([System.IO.Path]::Combine('$(_SourcyL8)', '.git'))</_SourcyGit8>
    <_SourcyGit9>$([System.IO.Path]::Combine('$(_SourcyL9)', '.git'))</_SourcyGit9>

    <!-- Check each level for .git (directory or file) -->
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and ($([System.IO.Directory]::Exists('$(_SourcyGit0)')) or $([System.IO.File]::Exists('$(_SourcyGit0)')))">$(_SourcyL0)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL1)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit1)')) or $([System.IO.File]::Exists('$(_SourcyGit1)')))">$(_SourcyL1)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL2)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit2)')) or $([System.IO.File]::Exists('$(_SourcyGit2)')))">$(_SourcyL2)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL3)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit3)')) or $([System.IO.File]::Exists('$(_SourcyGit3)')))">$(_SourcyL3)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL4)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit4)')) or $([System.IO.File]::Exists('$(_SourcyGit4)')))">$(_SourcyL4)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL5)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit5)')) or $([System.IO.File]::Exists('$(_SourcyGit5)')))">$(_SourcyL5)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL6)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit6)')) or $([System.IO.File]::Exists('$(_SourcyGit6)')))">$(_SourcyL6)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL7)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit7)')) or $([System.IO.File]::Exists('$(_SourcyGit7)')))">$(_SourcyL7)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL8)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit8)')) or $([System.IO.File]::Exists('$(_SourcyGit8)')))">$(_SourcyL8)</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL9)' != '' and ($([System.IO.Directory]::Exists('$(_SourcyGit9)')) or $([System.IO.File]::Exists('$(_SourcyGit9)')))">$(_SourcyL9)</SourcyRootPath>
  </PropertyGroup>

  <!-- Fallback to global.json, then Directory.Build.props -->
  <PropertyGroup>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), 'global.json'))</SourcyRootPath>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), 'Directory.Build.props'))</SourcyRootPath>
  </PropertyGroup>

  <!-- Make SourcyRootPath visible to source generators via AnalyzerConfigOptionsProvider -->
  <ItemGroup>
    <CompilerVisibleProperty Include="SourcyRootPath" />
  </ItemGroup>
</Project>
