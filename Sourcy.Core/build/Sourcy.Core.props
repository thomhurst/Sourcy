<Project>
  <!--
    Sourcy Root Detection
    =====================
    This props file finds the repository root at MSBuild evaluation time.

    Priority order:
    1. .sourcyroot (explicit marker file - highest priority)
    2. .git (as directory or file - handles normal repos, worktrees, and submodules)
    3. global.json (.NET SDK convention)
    4. Directory.Build.props (MSBuild convention - checked last as nested projects may have their own)

    Users can override by setting SourcyRootPath explicitly in their project file.
  -->

  <!-- 1. Check for explicit .sourcyroot marker file -->
  <PropertyGroup>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), '.sourcyroot'))</SourcyRootPath>
  </PropertyGroup>

  <!--
    2. .git detection using System.IO to find both directories and files.
    GetDirectoryNameOfFileAbove only finds files, but .git is usually a directory.
    Walk up to 10 levels to find .git (as directory OR file for worktrees/submodules).
    Uses Path.Combine for cross-platform path construction.

    First, compute all the directory levels and .git paths.
  -->
  <PropertyGroup Condition="'$(SourcyRootPath)' == ''">
    <_SourcyL0>$(MSBuildProjectDirectory)</_SourcyL0>
    <_SourcyL1>$([System.IO.Path]::GetDirectoryName('$(_SourcyL0)'))</_SourcyL1>
    <_SourcyL2>$([System.IO.Path]::GetDirectoryName('$(_SourcyL1)'))</_SourcyL2>
    <_SourcyL3>$([System.IO.Path]::GetDirectoryName('$(_SourcyL2)'))</_SourcyL3>
    <_SourcyL4>$([System.IO.Path]::GetDirectoryName('$(_SourcyL3)'))</_SourcyL4>
    <_SourcyL5>$([System.IO.Path]::GetDirectoryName('$(_SourcyL4)'))</_SourcyL5>
    <_SourcyL6>$([System.IO.Path]::GetDirectoryName('$(_SourcyL5)'))</_SourcyL6>
    <_SourcyL7>$([System.IO.Path]::GetDirectoryName('$(_SourcyL6)'))</_SourcyL7>
    <_SourcyL8>$([System.IO.Path]::GetDirectoryName('$(_SourcyL7)'))</_SourcyL8>
    <_SourcyL9>$([System.IO.Path]::GetDirectoryName('$(_SourcyL8)'))</_SourcyL9>
  </PropertyGroup>

  <!-- Build .git paths in a separate PropertyGroup to ensure parent paths are evaluated first -->
  <PropertyGroup Condition="'$(SourcyRootPath)' == ''">
    <_SourcyGit0>$([System.IO.Path]::Combine('$(_SourcyL0)', '.git'))</_SourcyGit0>
    <_SourcyGit1>$([System.IO.Path]::Combine('$(_SourcyL1)', '.git'))</_SourcyGit1>
    <_SourcyGit2>$([System.IO.Path]::Combine('$(_SourcyL2)', '.git'))</_SourcyGit2>
    <_SourcyGit3>$([System.IO.Path]::Combine('$(_SourcyL3)', '.git'))</_SourcyGit3>
    <_SourcyGit4>$([System.IO.Path]::Combine('$(_SourcyL4)', '.git'))</_SourcyGit4>
    <_SourcyGit5>$([System.IO.Path]::Combine('$(_SourcyL5)', '.git'))</_SourcyGit5>
    <_SourcyGit6>$([System.IO.Path]::Combine('$(_SourcyL6)', '.git'))</_SourcyGit6>
    <_SourcyGit7>$([System.IO.Path]::Combine('$(_SourcyL7)', '.git'))</_SourcyGit7>
    <_SourcyGit8>$([System.IO.Path]::Combine('$(_SourcyL8)', '.git'))</_SourcyGit8>
    <_SourcyGit9>$([System.IO.Path]::Combine('$(_SourcyL9)', '.git'))</_SourcyGit9>
  </PropertyGroup>

  <!-- Check each level for .git directory -->
  <PropertyGroup Condition="'$(SourcyRootPath)' == ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit0)'))">$(_SourcyL0)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL1)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit1)'))">$(_SourcyL1)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL2)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit2)'))">$(_SourcyL2)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL3)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit3)'))">$(_SourcyL3)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL4)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit4)'))">$(_SourcyL4)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL5)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit5)'))">$(_SourcyL5)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL6)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit6)'))">$(_SourcyL6)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL7)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit7)'))">$(_SourcyL7)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL8)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit8)'))">$(_SourcyL8)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL9)' != ''">
    <SourcyRootPath Condition="$([System.IO.Directory]::Exists('$(_SourcyGit9)'))">$(_SourcyL9)</SourcyRootPath>
  </PropertyGroup>

  <!-- Check each level for .git file (worktrees/submodules) -->
  <PropertyGroup Condition="'$(SourcyRootPath)' == ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit0)'))">$(_SourcyL0)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL1)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit1)'))">$(_SourcyL1)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL2)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit2)'))">$(_SourcyL2)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL3)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit3)'))">$(_SourcyL3)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL4)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit4)'))">$(_SourcyL4)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL5)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit5)'))">$(_SourcyL5)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL6)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit6)'))">$(_SourcyL6)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL7)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit7)'))">$(_SourcyL7)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL8)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit8)'))">$(_SourcyL8)</SourcyRootPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(SourcyRootPath)' == '' and '$(_SourcyL9)' != ''">
    <SourcyRootPath Condition="$([System.IO.File]::Exists('$(_SourcyGit9)'))">$(_SourcyL9)</SourcyRootPath>
  </PropertyGroup>

  <!-- 3. Fallback to global.json -->
  <PropertyGroup>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), 'global.json'))</SourcyRootPath>
  </PropertyGroup>

  <!-- 4. Fallback to Directory.Build.props -->
  <PropertyGroup>
    <SourcyRootPath Condition="'$(SourcyRootPath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), 'Directory.Build.props'))</SourcyRootPath>
  </PropertyGroup>

  <!-- Make SourcyRootPath visible to source generators via AnalyzerConfigOptionsProvider -->
  <ItemGroup>
    <CompilerVisibleProperty Include="SourcyRootPath" />
  </ItemGroup>
</Project>
